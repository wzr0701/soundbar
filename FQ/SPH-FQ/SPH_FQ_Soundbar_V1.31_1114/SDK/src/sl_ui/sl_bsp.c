#include "sl_bsp.h"#include <fcntl.h>#include <silan_resources.h>#include <silan_addrspace.h>#include <stdio.h>#include <string.h>#include <sys/time.h>#include <zhuque_bsp_gpio.h>#include "sl_ui_cmd.h"bool hdmi_det_online=0;extern bool frist_hdmi_det_online;extern WDOG_ID wdtimer_resetdsp_init;extern bool frist_hdmi_init;//extern bool frist_hdmi_det;const unsigned char led_pin_tab[] ={	LED_PIN_SEG1,	LED_PIN_SEG2,	LED_PIN_SEG3,	LED_PIN_SEG4,	LED_PIN_SEG5,	LED_PIN_GRID11,	LED_PIN_GRID9,	LED_PIN_GRID10,	LED_PIN_GRID5,	LED_PIN_GRID12,	LED_PIN_GRID1,	LED_PIN_GRID6,	LED_PIN_GRID7,	LED_PIN_GRID8,	LED_PIN_GRID2,	LED_PIN_GRID4,	LED_PIN_GRID3};void bsp_init(void){    int value;	(*(volatile unsigned int  *)(0xbe0a0014)) = 10000;	(*(volatile unsigned int  *)(0xbe0a0018)) = 10000;    //AMP_MUTE:P2.13    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));    value &= ~(1 << SILAN_PADMUX2_SPDIF_IN0_CH2);    value &= ~(1 << SILAN_PADMUX2_PWM1_CH2);    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;    zhuque_bsp_gpio_set_mode(HW_MUTE_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(HW_MUTE_PIN, 0);    //BT_MUTE:P1.12    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));    value &= ~(1 << SILAN_PADMUX2_JTAG);    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;    value = REG32(KSEG1(SILAN_PADMUX_CTRL));    value &= ~(1 << SILAN_PADMUX_SPDIF_IN3);    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;	value = REG32(KSEG1(SILAN_PADMUX_CTRL));    value &= ~(1 << SILAN_PADMUX_UART3_2);    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;	//P1.15 hdmi_det    value = REG32(KSEG1(SILAN_PADMUX_CTRL));//0xba000024    value &= ~(1 << SILAN_PADMUX_UART1);//0	value &= ~(1 << SILAN_PADMUX_SPI);//5    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;    zhuque_bsp_gpio_set_mode(HW_BT_MUTE_PIN, GPIO_IN, PULLING_HIGH);	zhuque_bsp_gpio_set_value(HW_BT_MUTE_PIN, 1);	//set_hdmi_gain(0);#if 0    //P1.22 RGB:R     low enable    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));    value &= ~(1 << SILAN_PADMUX2_IISADC_FD2_CH2);    value &= ~(1 << SILAN_PADMUX2_UART1_CH2);    value &= ~(1 << SILAN_PADMUX2_PWM3_CH2);    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;    //P1.21 RGB:G     low enable    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));    value &= ~(1 << SILAN_PADMUX2_IISADC_FD1_CH2);    value &= ~(1 << SILAN_PADMUX2_UART1_CH2);    value &= ~(1 << SILAN_PADMUX2_PWM2_CH2);    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;    //P2.10 RGB:B     low enable    value = REG32(KSEG1(SILAN_PADMUX_CTRL));    value &= ~(1 << SILAN_PADMUX_SPDIF);    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));    value &= ~(1 << SILAN_PADMUX2_PWM7);    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;	//P1.15 HDMI_DET:    low is HDMI detected	value = REG32(KSEG1(SILAN_PADMUX_CTRL));    value &= ~(1 << SILAN_PADMUX_UART1);	value &= ~(1 << SILAN_PADMUX_SPI);    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;	value = REG32(KSEG1(SILAN_PADMUX_CTRL));	printf("SILAN_PADMUX_CTRL=0x%x\n", value);	value = REG32(KSEG1(SILAN_PADMUX_CTRL2));	printf("SILAN_PADMUX_CTRL2=0x%x\n", value);	show_led_off();	show_led_mode(SOURCE_SELECT_BT);	Hw_Amp_Mute();#endif	value = REG32(KSEG1(SILAN_PADMUX_CTRL));	printf("%s:SILAN_PADMUX_CTRL=0x%x\n",  __func__,value);	value = REG32(KSEG1(SILAN_PADMUX_CTRL2));	printf("%s:SILAN_PADMUX_CTRL2=0x%x\n",  __func__,value);	frist_hdmi_init = true;	printf(">>>>>>>>>>>bsp initial ... \n");}void Hw_Amp_Mute(void){	zhuque_bsp_gpio_set_mode(HW_MUTE_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(HW_MUTE_PIN, 0); }void Hw_Amp_UnMute(void){	zhuque_bsp_gpio_set_mode(HW_MUTE_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(HW_MUTE_PIN, 1);#if 0    //MUTE:Green Off    zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_R_PIN, 1);    zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_G_PIN,1);    zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_B_PIN, 1); #endif}void show_led_off(void){    zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_R_PIN, 1);    zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(LED_G_PIN, 1);    zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(LED_B_PIN, 1);}void show_led_mode(int mode){	int value;    show_led_off();	switch(mode)	{		//P2.10 RGB:B	  low enable		case SOURCE_SELECT_LINEIN:			//AUX:Red			zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);            zhuque_bsp_gpio_set_value(LED_R_PIN, 0);            zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_G_PIN, 1);            zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_B_PIN, 1);			break;		case SOURCE_SELECT_LINEIN1:			//RCA:white白色			zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);            zhuque_bsp_gpio_set_value(LED_R_PIN, 0);            zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_G_PIN, 0);            zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_B_PIN, 0);			break;		/*		case SOURCE_SELECT_SPDIFIN:			zhuque_bsp_gpio_set_mode(LED_OPT_PIN, GPIO_OUT, PUSH_PULL);			zhuque_bsp_gpio_set_value(LED_OPT_PIN, 1);			break;		*/		case SOURCE_SELECT_HDMI:            //HDMI:Green        //Purple紫色			zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);            zhuque_bsp_gpio_set_value(LED_R_PIN, 1);            zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_G_PIN, 0);            zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_B_PIN, 1);			break;		case SOURCE_SELECT_BT:            //BT:Blue			zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);            zhuque_bsp_gpio_set_value(LED_R_PIN, 1);            zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_G_PIN, 1);            zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);        	zhuque_bsp_gpio_set_value(LED_B_PIN, 0);			break;	}}void close_led_mode(int mode){    zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_R_PIN, 1);    zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_G_PIN, 1);    zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_B_PIN, 1);}void mute_led_on(void){	 //MUTE:Green On    zhuque_bsp_gpio_set_mode(LED_R_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_R_PIN, 1);    zhuque_bsp_gpio_set_mode(LED_G_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_G_PIN, 0);    zhuque_bsp_gpio_set_mode(LED_B_PIN, GPIO_OUT, PUSH_PULL);    zhuque_bsp_gpio_set_value(LED_B_PIN, 1);}void Bt_Power_On(void){    #if 0	zhuque_bsp_gpio_set_mode(HW_BT_POWER_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(HW_BT_POWER_PIN, 1);    #endif}void Bt_Power_Off(void){    #if 0	zhuque_bsp_gpio_set_mode(HW_BT_POWER_PIN, GPIO_OUT, PUSH_PULL);	zhuque_bsp_gpio_set_value(HW_BT_POWER_PIN, 0);    #endif}int HDMI_Detect(void){	static int count1,count2;	uint32_t   det_value = 0xFF;	ui_cmd_t cmd;	int value;	zhuque_bsp_gpio_set_mode(HDMI_DET, GPIO_IN, PULLING_HIGH);	zhuque_bsp_gpio_get_value(HDMI_DET, &det_value);	/////////////////////////////////////////////////////	if(det_value ==0)	{		count2=0;		if(count1<100)		{			count1++;			if(count1>20)			{				count1=200;				hdmi_det_online=1;				if(frist_hdmi_det_online == false)				{					cmd.cmd = UI_CMD_HDMI_CONNECT;					send_cmd_2_ui(&cmd);				}			}		}	}	else	{		count1=0;		if(count2<100)		{			count2++;			if(count2>20)			{				count2=200;				hdmi_det_online=0;				frist_hdmi_det_online = false;				cmd.cmd = UI_CMD_HDMI_DISCONNECT;				send_cmd_2_ui(&cmd);			}		}	}	return 0;}/**********************************************************************************************************************************/void dsp_init_check(void){#if 1	int value;//////////////////////////////////////	//P1.15 hdmi_det	value = REG32(KSEG1(SILAN_PADMUX_CTRL));	value &= ~(1 << SILAN_PADMUX_UART1);	value &= ~(1 << SILAN_PADMUX_SPI);	REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;	//P2.10 RGB:B	  low enable	value = REG32(KSEG1(SILAN_PADMUX_CTRL));	value &= ~(1 << SILAN_PADMUX_SPDIF);	REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;	value = REG32(KSEG1(SILAN_PADMUX_CTRL2));	value &= ~(1 << SILAN_PADMUX2_PWM7);	REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;	//iic	value = REG32(KSEG1(SILAN_PADMUX_CTRL));	value &= ~(1 << SILAN_PADMUX_UART3_2);	REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;	////////////////////////////////////	if(wdtimer_resetdsp_init != NULL)	{		wd_start(wdtimer_resetdsp_init, 100,dsp_init_check, 0);/////50ms	}#endif}