/****************************************************************************
 * Included Files
 ****************************************************************************/
#include <nuttx/arch.h>
#include <nuttx/module.h>
#include <silan_addrspace.h>
#include <silan_resources.h>
#include <silan_timer.h>
#include <sys/types.h>
#include <zhuque_bsp_gpio.h>
#include "sc6138_led7.h"
/****************************************************************************
 * Pre-processor Definitions
 ****************************************************************************/
/*LED å¼•è„šæ•°é‡*/
#define LED_PIN_NUM 7
/*LED æ‰«ææ•°é‡*/
#define LED_SCAN_NUM 7
/*å¯æ˜¾ç¤ºçš„ç±»å‹*/
#define DISP_TYPE  NUMBER_TOTAL
/*æ•°ç ç®¡æ•°é‡*/
#define DIGITAL_NUM 4



#if 0
#define LED_PIN1 12     ///gpio1-12
#define LED_PIN2 13
#define LED_PIN3 14
#define LED_PIN4 15
#define LED_PIN5 16
#define LED_PIN6 17
#define LED_PIN7 18   ////gpio1-18
#endif


#if 1

/*
 * LEDé©±åŠ¨GPIO
 * 32   --  2_0
 * 33   --  2_1
 * 34   --  2_2
 * 35   --  2_3
 * 36   --  2_4
 * 37   --  2_5
 * 43   --  2_11
 */
#define LED_PIN1 32
#define LED_PIN2 33
#define LED_PIN3 34
#define LED_PIN4 35
#define LED_PIN5 36
#define LED_PIN6 37
#define LED_PIN7 43

#endif






/*åˆ·å±ä½¿ç”¨çš„è®¡æ—¶å™¨*/
#define LED7_TIMER          4
/*åˆ·å±çš„å‘¨æœŸ*/
#define LED7_SCAN_CYCLE  1000   //us
/****************************************************************************
 * Public Types
 ****************************************************************************/
/*
 * 7æ®µLEDå±æ˜¾ç¤ºä¿¡æ¯ç»“æ„ä½“
 */
struct led7_dis_info
{
    char digital_num[DIGITAL_NUM]; //display number value
    char colon;
    char dot;
    char usb;
    char sd;
    char fm;
    char play_pause;
    char replay;
    char bat_level;


};

/****************************************************************************
 * Public Data
 ****************************************************************************/
/*LEDæ˜¾ç¤ºç¼“å­˜*/
char led7_dis_bitbuf[LED_SCAN_NUM];
/*LEDæ•°æ®ç¼“å­˜*/
struct led7_dis_info led7_disbuf;
/*LEDå¼•è„šç¼–å·*/
static const int led7IONum[LED_PIN_NUM] = {
    LED_PIN1,
    LED_PIN2,
    LED_PIN3,
    LED_PIN4,
    LED_PIN5,
    LED_PIN6,
    LED_PIN7
};
/*æ˜¾ç¤ºæ®µç */


static const int ledDispSeg[][DISP_TYPE][LED_SCAN_NUM] = {
    /*ç¬¬0åˆ—*/
    {
	     {0x0e,0x01,0x00,0x01,0x01,0x00,0x00},////0
	     {0x04,0x00,0x00,0x00,0x01,0x00,0x00},
	     {0x0e,0x00,0x01,0x00,0x01,0x00,0x00},
	     {0x06,0x00,0x01,0x01,0x01,0x00,0x00},
	     {0x04,0x01,0x01,0x01,0x00,0x00,0x00},
	     {0x02,0x01,0x01,0x01,0x01,0x00,0x00},
	     {0x0a,0x01,0x01,0x01,0x01,0x00,0x00},
	     {0x06,0x00,0x00,0x01,0x00,0x00,0x00},
	     {0x0e,0x01,0x01,0x01,0x01,0x00,0x00},
	     {0x06,0x01,0x01,0x01,0x00,0x00,0x00},///9
	     {0x0e,0x01,0x01,0x01,0x00,0x00,0x00},//a
	     {0x08,0x01,0x01,0x01,0x01,0x00,0x00},//b
	     {0x0a,0x01,0x01,0x00,0x01,0x00,0x00},//e
	     {0x0c,0x01,0x01,0x01,0x00,0x00,0x00},//h
	     {0x08,0x01,0x00,0x00,0x01,0x00,0x00},///l
	     {0x0e,0x01,0x01,0x00,0x00,0x00,0x00},//p
	     {0x0c,0x01,0x00,0x01,0x01,0x00,0x00},//u
	     {0x06,0x01,0x01,0x00,0x00,0x00,0x00},//v
	     {0x00,0x00,0x01,0x00,0x00,0x00,0x00},//-
	     {0x0c,0x00,0x01,0x01,0x01,0x00,0x00},//d
	     {0x0a,0x01,0x01,0x00,0x00,0x00,0x00},//f
	     {0x0e,0x01,0x00,0x01,0x00,0x00,0x00},//n
	     {0x08,0x01,0x01,0x00,0x01,0x00,0x00},///t


    },
    /*ç¬¬1åˆ—*/
    {
	   {0x00,0x3c,0x02,0x00,0x02,0x00,0x00},
	   {0x00,0x08,0x00,0x00,0x02,0x00,0x00},
	   {0x00,0x3c,0x00,0x02,0x00,0x00,0x00},
	   {0x00,0x2c,0x00,0x02,0x02,0x00,0x00},
	   {0x00,0x08,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x24,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x34,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x0c,0x00,0x00,0x02,0x00,0x00},
	   {0x00,0x3c,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x0c,0x02,0x02,0x02,0x00,0x00},//9
	   {0x00,0x1c,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x30,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x34,0x02,0x02,0x00,0x00,0x00},
	   {0x00,0x18,0x02,0x02,0x02,0x00,0x00},
	   {0x00,0x30,0x02,0x00,0x00,0x00,0x00},
	   {0x00,0x1c,0x02,0x02,0x00,0x00,0x00},
	   {0x00,0x38,0x02,0x00,0x02,0x00,0x00},
	   {0x00,0x0c,0x02,0x02,0x00,0x00,0x00},
	   {0x00,0x00,0x00,0x02,0x00,0x00,0x00},
	   {0x00,0x38,0x00,0x02,0x02,0x00,0x00},
	   {0x00,0x14,0x02,0x02,0x00,0x00,0x00},
	   {0x00,0x1c,0x02,0x00,0x02,0x00,0x00},
	   {0x00,0x30,0x02,0x02,0x00,0x00,0x00},//t
    },
    /*ç¬¬2åˆ—*/
    {
      {0x00,0x00,0x10,0x14,0x08,0x05,0x00},
      {0x00,0x00,0x10,0x10,0x00,0x00,0x00},
      {0x00,0x00,0x10,0x00,0x0c,0x05,0x00},
      {0x00,0x00,0x10,0x10,0x0c,0x01,0x00},
      {0x00,0x00,0x10,0x14,0x04,0x00,0x00},
      {0x00,0x00,0x00,0x14,0x0c,0x01,0x00},
      {0x00,0x00,0x00,0x14,0x0c,0x05,0x00},
      {0x00,0x00,0x10,0x10,0x08,0x00,0x00},
      {0x00,0x00,0x10,0x14,0x0c,0x05,0x00},
      {0x00,0x00,0x10,0x14,0x0c,0x00,0x00},//9
      {0x00,0x00,0x10,0x14,0x0c,0x04,0x00},
      {0x00,0x00,0x00,0x14,0x04,0x05,0x00},
      {0x00,0x00,0x00,0x04,0x0c,0x05,0x00},
      {0x00,0x00,0x10,0x14,0x04,0x04,0x00},
      {0x00,0x00,0x00,0x04,0x00,0x05,0x00},
      {0x00,0x00,0x10,0x04,0x0c,0x04,0x00},
      {0x00,0x00,0x10,0x14,0x00,0x05,0x00},
      {0x00,0x00,0x10,0x04,0x0c,0x00,0x00},
      {0x00,0x00,0x00,0x00,0x04,0x00,0x00},
      {0x00,0x00,0x10,0x10,0x04,0x05,0x00},
      {0x00,0x00,0x00,0x04,0x0c,0x04,0x00},
      {0x00,0x00,0x10,0x14,0x08,0x04,0x00},
      {0x00,0x00,0x00,0x04,0x04,0x05,0x00},  ///t

    },
    /*ç¬¬3åˆ—*/
    {
      {0x00,0x00,0x00,0x20,0x20,0x58,0x20},
      {0x00,0x00,0x00,0x00,0x20,0x40,0x00},
      {0x00,0x00,0x00,0x20,0x40,0x48,0x20},
      {0x00,0x00,0x00,0x00,0x60,0x48,0x20},
      {0x00,0x00,0x00,0x00,0x60,0x50,0x00},
      {0x00,0x00,0x00,0x00,0x60,0x18,0x20},
      {0x00,0x00,0x00,0x20,0x60,0x18,0x20},
      {0x00,0x00,0x00,0x00,0x20,0x40,0x20},
      {0x00,0x00,0x00,0x20,0x60,0x58,0x20},
      {0x00,0x00,0x00,0x00,0x60,0x50,0x20},//9
      {0x00,0x00,0x00,0x20,0x60,0x50,0x20},
      {0x00,0x00,0x00,0x20,0x60,0x18,0x00},
      {0x00,0x00,0x00,0x20,0x40,0x18,0x20},
      {0x00,0x00,0x00,0x20,0x60,0x50,0x00},
      {0x00,0x00,0x00,0x20,0x00,0x18,0x00},
      {0x00,0x00,0x00,0x20,0x40,0x50,0x20},
      {0x00,0x00,0x00,0x20,0x20,0x58,0x00},
      {0x00,0x00,0x00,0x00,0x40,0x50,0x20},
      {0x00,0x00,0x00,0x00,0x40,0x00,0x00},
      {0x00,0x00,0x00,0x20,0x60,0x48,0x00},
      {0x00,0x00,0x00,0x20,0x40,0x10,0x20},
      {0x00,0x00,0x00,0x20,0x20,0x50,0x20},
      {0x00,0x00,0x00,0x20,0x40,0x18,0x00},//t

    }
};








#if 0
static const int ledDispSeg[][DISP_TYPE][LED_SCAN_NUM] = {
    /*ç¬¬0åˆ—*/
    {
        {0x7e, 0x00, 0x00, 0x00, 0x00},     //0
        {0x0c, 0x00, 0x00, 0x00, 0x00},     //1
        {0x36, 0x00, 0x00, 0x00, 0x01},     //2
        {0x1e, 0x00, 0x00, 0x00, 0x01},     //3
        {0x4c, 0x00, 0x00, 0x00, 0x01},     //4
        {0x5a, 0x00, 0x00, 0x00, 0x01},     //5
        {0x7a, 0x00, 0x00, 0x00, 0x01},     //6
        {0x0e, 0x00, 0x00, 0x00, 0x00},     //7
        {0x7e, 0x00, 0x00, 0x00, 0x01},     //8
        {0x5e, 0x00, 0x00, 0x00, 0x01},     //9
        {0x6e, 0x00, 0x00, 0x00, 0x01},     //A
        {0x78, 0x00, 0x00, 0x00, 0x01},     //b
        {0x72, 0x00, 0x00, 0x00, 0x01},     //E
        {0x6c, 0x00, 0x00, 0x00, 0x01},     //H
        {0x70, 0x00, 0x00, 0x00, 0x00},     //L
        {0x66, 0x00, 0x00, 0x00, 0x01},     //P
        {0x7c, 0x00, 0x00, 0x00, 0x00},     //U
        {0x38, 0x00, 0x00, 0x00, 0x00},     //v
        {0x00, 0x00, 0x00, 0x00, 0x01},     //-
        {0x3c, 0x00, 0x00, 0x00, 0x01},     //d
        {0x62, 0x00, 0x00, 0x00, 0x01},     //F
        {0x6e, 0x00, 0x00, 0x00, 0x00},     //N
    },
    /*ç¬¬1åˆ—*/
    {
        {0x00, 0x7d, 0x00, 0x00, 0x00},     //0
        {0x00, 0x0c, 0x00, 0x00, 0x00},     //1
        {0x00, 0x35, 0x00, 0x00, 0x02},     //2
        {0x00, 0x1d, 0x00, 0x00, 0x02},     //3
        {0x00, 0x4c, 0x00, 0x00, 0x02},     //4
        {0x00, 0x59, 0x00, 0x00, 0x02},     //5
        {0x00, 0x79, 0x00, 0x00, 0x02},     //6
        {0x00, 0x0d, 0x00, 0x00, 0x00},     //7
        {0x00, 0x7d, 0x00, 0x00, 0x02},     //8
        {0x00, 0x5d, 0x00, 0x00, 0x02},     //9
        {0x00, 0x6d, 0x00, 0x00, 0x02},     //A
        {0x00, 0x78, 0x00, 0x00, 0x02},     //b
        {0x00, 0x71, 0x00, 0x00, 0x02},     //E
        {0x00, 0x6c, 0x00, 0x00, 0x02},     //H
        {0x00, 0x70, 0x00, 0x00, 0x00},     //L
        {0x00, 0x65, 0x00, 0x00, 0x02},     //P
        {0x00, 0x7c, 0x00, 0x00, 0x00},     //U
        {0x00, 0x38, 0x00, 0x00, 0x00},     //v
        {0x00, 0x00, 0x00, 0x00, 0x02},     //-
        {0x00, 0x3c, 0x00, 0x00, 0x02},     //d
        {0x00, 0x61, 0x00, 0x00, 0x02},     //F
        {0x00, 0x6d, 0x00, 0x00, 0x00},     //N
    },
    /*ç¬¬2åˆ—*/
    {
        {0x00, 0x00, 0x7b, 0x00, 0x00},     //0
        {0x00, 0x00, 0x0a, 0x00, 0x00},     //1
        {0x00, 0x00, 0x33, 0x00, 0x04},     //2
        {0x00, 0x00, 0x1b, 0x00, 0x04},     //3
        {0x00, 0x00, 0x4a, 0x00, 0x04},     //4
        {0x00, 0x00, 0x59, 0x00, 0x04},     //5
        {0x00, 0x00, 0x79, 0x00, 0x04},     //6
        {0x00, 0x00, 0x0b, 0x00, 0x00},     //7
        {0x00, 0x00, 0x7b, 0x00, 0x04},     //8
        {0x00, 0x00, 0x5b, 0x00, 0x04},     //9
        {0x00, 0x00, 0x6b, 0x00, 0x04},     //A
        {0x00, 0x00, 0x78, 0x00, 0x04},     //b
        {0x00, 0x00, 0x71, 0x00, 0x04},     //E
        {0x00, 0x00, 0x6a, 0x00, 0x04},     //H
        {0x00, 0x00, 0x70, 0x00, 0x00},     //L
        {0x00, 0x00, 0x63, 0x00, 0x04},     //P
        {0x00, 0x00, 0x7a, 0x00, 0x00},     //U
        {0x00, 0x00, 0x38, 0x00, 0x00},     //v
        {0x00, 0x00, 0x00, 0x00, 0x04},     //-
        {0x00, 0x00, 0x3a, 0x00, 0x04},     //d
        {0x00, 0x00, 0x61, 0x00, 0x04},     //F
        {0x00, 0x00, 0x6b, 0x00, 0x00},     //N
    },
    /*ç¬¬3åˆ—*/
    {
        {0x00, 0x00, 0x00, 0x77, 0x00},     //0
        {0x00, 0x00, 0x00, 0x06, 0x00},     //1
        {0x00, 0x00, 0x00, 0x33, 0x08},     //2
        {0x00, 0x00, 0x00, 0x17, 0x08},     //3
        {0x00, 0x00, 0x00, 0x46, 0x08},     //4
        {0x00, 0x00, 0x00, 0x55, 0x08},     //5
        {0x00, 0x00, 0x00, 0x75, 0x08},     //6
        {0x00, 0x00, 0x00, 0x07, 0x00},     //7
        {0x00, 0x00, 0x00, 0x77, 0x08},     //8
        {0x00, 0x00, 0x00, 0x57, 0x08},     //9
        {0x00, 0x00, 0x00, 0x67, 0x08},     //A
        {0x00, 0x00, 0x00, 0x74, 0x08},     //b
        {0x00, 0x00, 0x00, 0x71, 0x08},     //E
        {0x00, 0x00, 0x00, 0x66, 0x08},     //H
        {0x00, 0x00, 0x00, 0x70, 0x00},     //L
        {0x00, 0x00, 0x00, 0x63, 0x08},     //P
        {0x00, 0x00, 0x00, 0x76, 0x00},     //U
        {0x00, 0x00, 0x00, 0x34, 0x00},     //v
        {0x00, 0x00, 0x00, 0x00, 0x08},     //-
        {0x00, 0x00, 0x00, 0x36, 0x08},     //d
        {0x00, 0x00, 0x00, 0x61, 0x08},     //F
        {0x00, 0x00, 0x00, 0x67, 0x00},     //N
    }
};

#endif





/****************************************************************************
 * Public Function Prototypes
 ****************************************************************************/
void led7_clear_display(void);
void led7_update_bitbuf(void);

/****************************************************************************
 * Public Functions
 ****************************************************************************/

/****************************************************************************
 * Name: led_7p7s_scan
 *
 * Description:
 *    7æ®µLEDå±æ˜¾ç¤ºæ‰«æç¨‹åº
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
static void led_7p7s_scan(void)
{
#if 0
    static int led_fresh_cnt = 0;

    led7_clear_display();

    led_fresh_cnt++;
    if (led_fresh_cnt >= LED_SCAN_NUM)
    {
        led_fresh_cnt = 0;
    }

    char seg_code = led7_dis_bitbuf[led_fresh_cnt];

    if(seg_code & 0x7f)
    {   //éœ€è¦æ˜¾ç¤º
        int i = 0;
        int pin = led7IONum[led_fresh_cnt];

        //æ‰«æå£è¾“å‡ºä½
        zhuque_bsp_gpio_set_mode(pin, GPIO_OUT, PULLING_NONE);
        zhuque_bsp_gpio_set_value(pin, GPIO_VALUE_LOW);

        for(i=0; i < LED_PIN_NUM; ++i)
        {
            if (seg_code & (1 << i))
            {
                pin = led7IONum[i];
                zhuque_bsp_gpio_set_mode(pin, GPIO_OUT, PULLING_NONE);
                zhuque_bsp_gpio_set_value(pin, GPIO_VALUE_HIGH);
            }
        }
    }
#endif
}

/****************************************************************************
 * Name: led7_clear_display
 *
 * Description:
 *    æ¸…é™¤LEDå±æ˜¾ç¤º
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_clear_display(void)
{
#if 0
    int i = 0;
    //åˆå§‹åŒ–IOå£æ¨¡å¼å’ŒçŠ¶æ€
    for(i=0;i<LED_PIN_NUM;++i)
    {
        zhuque_bsp_gpio_set_mode(led7IONum[i], GPIO_IN, PULLING_NONE);
        zhuque_bsp_gpio_set_value(led7IONum[i], GPIO_VALUE_LOW);
    }
#endif
}
/****************************************************************************
 * Name: led7_clear_bitbuf
 *
 * Description:
 *   Ã¦Â¸â€¦Ã©â„¢Â¤7Ã¦Â®ÂµLEDÃ¥Â±ï¿½Ã§Å¡â€Ã¦ËœÂ¾Ã§Â¤ÂºÃ§Â¼â€œÃ¥â€ Â²
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_clear_bitbuf(void)
{
    int i;
    for (i = 0; i < LED_SCAN_NUM; i++)
    {
        led7_dis_bitbuf[i] = 0;
    }
}

/****************************************************************************
 * Name: led7_clear_disbuf
 *
 * Description:
 *   æ¸…é™¤æ•°æ®ç¼“å­˜åŒº
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_clear_disbuf(void)
{
    led7_disbuf.digital_num[0] = 0;
    led7_disbuf.digital_num[1] = 0;
    led7_disbuf.digital_num[2] = 0;
    led7_disbuf.digital_num[3] = 0;

    led7_disbuf.colon = 0;
    led7_disbuf.dot = 0;
    led7_disbuf.fm = 0;
    led7_disbuf.usb = 0;
    led7_disbuf.sd = 0;
    led7_disbuf.play_pause = 0;
    led7_disbuf.replay = 0;
    led7_disbuf.bat_level= 0;

}

/****************************************************************************
 * Name: led7_init
 *
 * Description:
 *   7æ®µLEDå±é©±åŠ¨åˆå§‹åŒ–
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_init(void)
{


#if 0

    //åˆå§‹åŒ–é©±åŠ¨GPIO
    int value = REG32(KSEG1(SILAN_PADMUX_CTRL));

    value &= ~(1 << SILAN_PADMUX_UART3_1);
    value &= ~(1 << SILAN_PADMUX_UART1);
    value &= ~(1 << SILAN_PADMUX_SPI);
    value &= ~(1 << SILAN_PADMUX_I2C1);
    value &= ~(1 << SILAN_PADMUX_SPDIF_IN3);

    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;

/////////////////////////////////////////////////

    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));

    value &= ~(1 << SILAN_PADMUX2_JTAG);

    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;
//////////////////////////////////////////////


    REG32(KSEG1(0xba000048)) = 0xffffffff; 	////Çı¶¯ÄÜÁ¦
#endif





#if 0

    //åˆå§‹åŒ–é©±åŠ¨GPIO
    int value = REG32(KSEG1(SILAN_PADMUX_CTRL));
    value &= ~(1 << SILAN_PADMUX_SDIO);
    value &= ~(1 << SILAN_PADMUX_SDIODAT);
    value &= ~(1 << SILAN_PADMUX_SDIODET);
    value &= ~(1 << SILAN_PADMUX_GMAC);
    value &= ~(1 << SILAN_PADMUX_UART3_2);
    value &= ~(1 << SILAN_PADMUX_I2C2);
    REG32(KSEG1(SILAN_PADMUX_CTRL)) = value;

    value = REG32(KSEG1(SILAN_PADMUX_CTRL2));
    value &= ~(1 << SILAN_PADMUX2_IISADC_MODE);
    value &= ~(1 << SILAN_PADMUX2_IISADC_FD1_CH2);
    REG32(KSEG1(SILAN_PADMUX_CTRL2)) = value;
    REG32(KSEG1(0xba00004c)) = 0xffffffff;

#endif




    //æ¸…é™¤ç¼“å­˜æ•°æ®
    led7_clear_disbuf();
    led7_clear_bitbuf();
    //æ›´æ–°æ˜¾ç¤º
    led7_update_bitbuf();

    //åœæ­¢è®¡æ—¶
    sc6138_timer_stop(LED7_TIMER);

    led7_clear_display();
}

/****************************************************************************
 * Name: led7_off
 *
 * Description:
 *   å…³é—­LEDå±
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_off(void)
{
    //åœæ­¢LEDåˆ·æ–°TIMER
    sc6138_timer_stop(4);

    //æ¸…é™¤ç¼“å­˜æ•°æ®
    led7_clear_disbuf();
    led7_clear_bitbuf();
    //æ¸…é™¤æ˜¾ç¤º
    led7_clear_display();
}

/****************************************************************************
 * Name: led7_open
 *
 * Description:
 *   æ‰“å¼€LEDå±
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_open(void)
{
#if 0
    //åœæ­¢è®¡æ—¶
    sc6138_timer_stop(LED7_TIMER);
    //å¯åŠ¨LEDå±æ‰«æè®¡æ—¶å™¨
    sc6138_timer_initialize(LED7_TIMER, LED7_SCAN_CYCLE, led_7p7s_scan);
    //å¯åŠ¨LEDè®¡æ—¶
    sc6138_timer_start(LED7_TIMER);
#endif
}

/****************************************************************************
 * Name: led7_set_colon
 *
 * Description:
 *   æ˜¾ç¤ºä¸¤ç‚¹
 *
 * Parameters:
 *   disp  trueæ˜¾ç¤ºä¸¤ç‚¹ï¼Œfalseéšè—ä¸¤ç‚¹
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_set_colon(bool disp)
{
    led7_disbuf.colon = disp;

}

void led7_set_dot(bool disp)
{
    led7_disbuf.colon = disp;

}


void led7_set_usb(bool disp)
{
    led7_disbuf.usb = disp;

}



void led7_set_sd(bool disp)
{
    led7_disbuf.sd = disp;
}


void led7_set_fm(bool disp)
{
    led7_disbuf.fm = disp;

}


void led7_set_play_pause(bool disp)
{
    led7_disbuf.play_pause = disp;
}

void led7_set_replay(bool disp)
{
    led7_disbuf.replay = disp;

}

void led7_set_bat_level(char level)//1/////1,2,3
{
     led7_disbuf.bat_level = level;
}

/*******************************************************************




*******************************************************************/
void led7_update_char(void)
{
   if(led7_disbuf.colon)
      led7_dis_bitbuf[2]|=0x08;
  else
     led7_dis_bitbuf[2]&=~0x08;

///////////////////////////////////////

   if(led7_disbuf.dot)
      led7_dis_bitbuf[6]|=0x10;
  else
     led7_dis_bitbuf[6]&=~0x10;


////////////////////////////////////////
    if(led7_disbuf.usb )
  	{
      led7_dis_bitbuf[0]|=0x20;
      led7_dis_bitbuf[1]|=0x40;
  	}
  else
  	{
      led7_dis_bitbuf[0]&=~0x20;
      led7_dis_bitbuf[1]&=~0x40;
  	}
////////////////////////////////////

   if( led7_disbuf.sd )
  	{
      led7_dis_bitbuf[2]|=0x20;
      led7_dis_bitbuf[6]|=0x02;
  	}
  else
  	{
      led7_dis_bitbuf[2]&=~0x20;
      led7_dis_bitbuf[6]&=~0x02;
  	}
 /////////////////////////////////////
    if(led7_disbuf.fm)
      led7_dis_bitbuf[5]|=0x02;
  else
     led7_dis_bitbuf[5]&=~0x02;
//////////////////////////////////////
   if( led7_disbuf.play_pause )
      led7_dis_bitbuf[0]|=0x10;
  else
     led7_dis_bitbuf[0]&=~0x10;

///////////////////////////////////////

   if( led7_disbuf.replay )
  	{
      led7_dis_bitbuf[6]|=0x01;
      led7_dis_bitbuf[6]|=0x04;
  	}
  else
  	{
      led7_dis_bitbuf[6]&=~0x01;
      led7_dis_bitbuf[6]&=~0x04;
  	}

////////////////////////////////////////

     if(led7_disbuf.bat_level )
   	{
      led7_dis_bitbuf[2]&=~0x40;
      led7_dis_bitbuf[3]&=~0x40;
      led7_dis_bitbuf[6]&=~0x08;
   	}
    else if(led7_disbuf.bat_level ==1)
    	{
      led7_dis_bitbuf[2]|=0x40;
      led7_dis_bitbuf[3]&=~0x40;
      led7_dis_bitbuf[6]&=~0x08;
    	}
    else if(led7_disbuf.bat_level ==2)
    	{
      led7_dis_bitbuf[2]|=0x40;
      led7_dis_bitbuf[3]|=0x40;
      led7_dis_bitbuf[6]&=~0x08;
    	}

    else if(led7_disbuf.bat_level ==3)
    	{
      led7_dis_bitbuf[2]|=0x40;
      led7_dis_bitbuf[3]|=0x40;
      led7_dis_bitbuf[6]|=0x08;
    	}


}

















/****************************************************************************
 * Name: led7_set_display
 *
 * Description:
 *   è®¾ç½®ç¬¬Xä¸ªLEDæ˜¾ç¤ºçš„å†…å®¹
 *
 * Parameters:
 *   index  LEDçš„åºå·0~3
 *   disp   è¦æ˜¾ç¤ºçš„å†…å®¹
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
void led7_set_display(int index, char disp)
{
    if(index >= 0 && index < DIGITAL_NUM)
    {
        led7_disbuf.digital_num[index] = disp;
    }
}

/****************************************************************************
 * Name: led7_update_bitbuf
 *
 * Description:
 *   æ›´æ–°æ˜¾ç¤ºç¼“å­˜æ•°æ®
 *
 * Parameters:
 *
 * Returned Value:
 *
 * Assumptions:
 *
 ****************************************************************************/
//ä»å·¦åˆ°å³0-1
//bit    6    5    4    3    2    1    0
//buf 0--F0   E0   D0   C0   B0   A0   0
//buf 1--F1   E1   D1   C1   B1   0    A1
//buf 2--F2   E2   D2   C2   0    B2   A2
//buf 3--F3   E3   D3   0    C3   B3   A3
//buf 4--0    0    0    G3   G2   G1   G0
void led7_update_bitbuf(void)
{
    int i, j, type;

    led7_clear_bitbuf();

    for (j = 0; j < DIGITAL_NUM; ++j)
    {
        type = led7_disbuf.digital_num[j];
        if(0 <= type && type < DISP_TYPE)
        {
            for(i = 0; i < LED_SCAN_NUM; ++i)
            {
                led7_dis_bitbuf[i] |= ledDispSeg[j][type][i];
            }
        }
    }

led7_update_char();

}
